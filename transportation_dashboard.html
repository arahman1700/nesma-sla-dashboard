<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Nesma SLA - Transportation Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/nesma-theme.css">
    <style>
        :root {
            --primary: #2E3192;
            --secondary: #80D1E9;
            --accent: #0E2841;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            background: linear-gradient(180deg, #E8E8E8 0%, #F5F5F5 100%);
            min-height: 100vh;
        }

        body.ltr {
            direction: ltr;
            font-family: 'Inter', 'Cairo', sans-serif;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .gradient-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }

        .stat-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(46, 49, 146, 0.2);
        }

        .filter-select {
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(46, 49, 146, 0.1);
        }

        .data-table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tr:hover td {
            background-color: #f0f4ff;
        }

        .tab-btn {
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success { background: #d1fae5; color: #059669; }
        .badge-warning { background: #fef3c7; color: #d97706; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        .badge-info { background: #dbeafe; color: #2563eb; }
    </style>
</head>
<body class="ltr">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600" id="loadingText">Loading data...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="gradient-primary text-white py-4 px-6 shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <a href="logistics_portal.html" class="text-white/80 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                    </svg>
                </a>
                <img src="assets/logo-white.svg" alt="NESMA" class="h-8 lg:h-10">
                <div>
                    <h1 class="text-2xl font-bold" id="pageTitle">Transportation & Equipment Dashboard</h1>
                    <p class="text-white/70 text-sm" id="pageSubtitle">Comprehensive Analysis of Transportation Orders</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="exportData()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                    </svg>
                    <span id="exportText">Export</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Filters Section -->
    <section class="max-w-7xl mx-auto px-6 py-6">
        <div class="glass-card rounded-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-800" id="filtersTitle">Interactive Filters</h2>
                <button onclick="resetFilters()" class="text-sm text-[#2e3192] hover:underline" id="resetBtn">Reset</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1" id="projectLabel">Project</label>
                    <select id="filterProject" onchange="applyFilters()" class="filter-select w-full px-3 py-2 rounded-lg outline-none">
                        <option value="">All</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1" id="supplierLabel">Supplier</label>
                    <select id="filterSupplier" onchange="applyFilters()" class="filter-select w-full px-3 py-2 rounded-lg outline-none">
                        <option value="">All</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1" id="equipmentLabel">Equipment</label>
                    <select id="filterEquipment" onchange="applyFilters()" class="filter-select w-full px-3 py-2 rounded-lg outline-none">
                        <option value="">All</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1" id="statusLabel">Status</label>
                    <select id="filterStatus" onchange="applyFilters()" class="filter-select w-full px-3 py-2 rounded-lg outline-none">
                        <option value="">All</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1" id="rentTypeLabel">Rent Type</label>
                    <select id="filterRentType" onchange="applyFilters()" class="filter-select w-full px-3 py-2 rounded-lg outline-none">
                        <option value="">All</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600 mb-1" id="dateFromLabel">From Date</label>
                    <input type="date" id="filterDateFrom" onchange="applyFilters()" class="filter-select w-full px-3 py-2 rounded-lg outline-none">
                </div>
            </div>
            <div id="activeFilters" class="mt-4 flex flex-wrap gap-2 hidden"></div>
        </div>
    </section>

    <!-- KPI Cards -->
    <section class="max-w-7xl mx-auto px-6 pb-6">
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
            <div class="stat-card glass-card rounded-xl p-4">
                <div class="text-3xl mb-2">ğŸš›</div>
                <div class="text-2xl font-bold text-[#2e3192]" id="kpiTotalOrders">0</div>
                <div class="text-sm text-gray-500" id="kpiTotalOrdersLabel">Total Orders</div>
            </div>
            <div class="stat-card glass-card rounded-xl p-4">
                <div class="text-3xl mb-2">ğŸ’°</div>
                <div class="text-2xl font-bold text-[#2e3192]" id="kpiTotalAmount">0</div>
                <div class="text-sm text-gray-500" id="kpiTotalAmountLabel">Total Amount (SAR)</div>
            </div>
            <div class="stat-card glass-card rounded-xl p-4">
                <div class="text-3xl mb-2">âœ…</div>
                <div class="text-2xl font-bold text-green-600" id="kpiDoneCount">0</div>
                <div class="text-sm text-gray-500" id="kpiDoneLabel">Completed</div>
            </div>
            <div class="stat-card glass-card rounded-xl p-4">
                <div class="text-3xl mb-2">â³</div>
                <div class="text-2xl font-bold text-yellow-600" id="kpiInProgressCount">0</div>
                <div class="text-sm text-gray-500" id="kpiInProgressLabel">In Progress</div>
            </div>
            <div class="stat-card glass-card rounded-xl p-4">
                <div class="text-3xl mb-2">âš¡</div>
                <div class="text-2xl font-bold text-[#80d1e9]" id="kpiAvgDuration">0</div>
                <div class="text-sm text-gray-500" id="kpiAvgDurationLabel">Avg. Duration (Days)</div>
            </div>
            <div class="stat-card glass-card rounded-xl p-4">
                <div class="text-3xl mb-2">ğŸ“Š</div>
                <div class="text-2xl font-bold text-purple-600" id="kpiOnTimeRate">0%</div>
                <div class="text-sm text-gray-500" id="kpiOnTimeRateLabel">Completion Rate</div>
            </div>
        </div>
    </section>

    <!-- Tabs -->
    <section class="max-w-7xl mx-auto px-6 pb-6">
        <div class="glass-card rounded-2xl overflow-hidden">
            <div class="flex border-b overflow-x-auto">
                <button onclick="switchTab('overview')" class="tab-btn active flex-1 px-6 py-3 text-center font-medium" id="tabOverview">Overview</button>
                <button onclick="switchTab('suppliers')" class="tab-btn flex-1 px-6 py-3 text-center font-medium" id="tabSuppliers">Suppliers</button>
                <button onclick="switchTab('projects')" class="tab-btn flex-1 px-6 py-3 text-center font-medium" id="tabProjects">Projects</button>
                <button onclick="switchTab('equipment')" class="tab-btn flex-1 px-6 py-3 text-center font-medium" id="tabEquipment">Equipment</button>
                <button onclick="switchTab('details')" class="tab-btn flex-1 px-6 py-3 text-center font-medium" id="tabDetails">Details</button>
            </div>

            <div class="p-6">
                <!-- Overview Tab -->
                <div id="overviewContent" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="chart-container">
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="mt-6">
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="supplierBarChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Suppliers Tab -->
                <div id="suppliersContent" class="tab-content hidden">
                    <div class="overflow-x-auto">
                        <table class="data-table w-full">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left" id="thSupplier">Supplier</th>
                                    <th class="px-4 py-3 text-left" id="thOrderCount">Order Count</th>
                                    <th class="px-4 py-3 text-left" id="thTotalAmount">Total Amount</th>
                                    <th class="px-4 py-3 text-left" id="thAvgAmount">Avg. Amount</th>
                                    <th class="px-4 py-3 text-left" id="thPercentage">Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="suppliersTableBody"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 chart-container">
                        <canvas id="supplierPieChart"></canvas>
                    </div>
                </div>

                <!-- Projects Tab -->
                <div id="projectsContent" class="tab-content hidden">
                    <div class="overflow-x-auto max-h-96">
                        <table class="data-table w-full">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left" id="thProject">Project</th>
                                    <th class="px-4 py-3 text-left" id="thProjectOrders">Order Count</th>
                                    <th class="px-4 py-3 text-left" id="thProjectTotal">Total Amount</th>
                                    <th class="px-4 py-3 text-left" id="thProjectAvg">Avg. Duration</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 chart-container" style="height: 400px;">
                        <canvas id="projectBarChart"></canvas>
                    </div>
                </div>

                <!-- Equipment Tab -->
                <div id="equipmentContent" class="tab-content hidden">
                    <div class="overflow-x-auto max-h-96">
                        <table class="data-table w-full">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left" id="thEquipmentName">Equipment</th>
                                    <th class="px-4 py-3 text-left" id="thEquipmentCount">Count</th>
                                    <th class="px-4 py-3 text-left" id="thEquipmentTotal">Total Amount</th>
                                    <th class="px-4 py-3 text-left" id="thEquipmentAvg">Avg. Price</th>
                                </tr>
                            </thead>
                            <tbody id="equipmentTableBody"></tbody>
                        </table>
                    </div>
                    <div class="mt-6 chart-container" style="height: 400px;">
                        <canvas id="equipmentChart"></canvas>
                    </div>
                </div>

                <!-- Details Tab -->
                <div id="detailsContent" class="tab-content hidden">
                    <div class="mb-4 flex items-center gap-4">
                        <div class="relative flex-1">
                            <input type="text" id="searchInput" onkeyup="searchRecords()" placeholder="Search..." class="filter-select w-full px-4 py-2 pl-10 rounded-lg outline-none">
                            <svg class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                        <div class="text-sm text-gray-500">
                            <span id="recordsShowing">0</span> <span id="recordsOfLabel">of</span> <span id="recordsTotal">0</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto max-h-[500px]">
                        <table class="data-table w-full text-sm">
                            <thead>
                                <tr>
                                    <th class="px-3 py-2 text-left">#</th>
                                    <th class="px-3 py-2 text-left" id="thDetailJobOrder">Job Order</th>
                                    <th class="px-3 py-2 text-left" id="thDetailDate">Date</th>
                                    <th class="px-3 py-2 text-left" id="thDetailProject">Project</th>
                                    <th class="px-3 py-2 text-left" id="thDetailSupplier">Supplier</th>
                                    <th class="px-3 py-2 text-left" id="thDetailEquipment">Equipment</th>
                                    <th class="px-3 py-2 text-left" id="thDetailAmount">Amount</th>
                                    <th class="px-3 py-2 text-left" id="thDetailStatus">Status</th>
                                </tr>
                            </thead>
                            <tbody id="detailsTableBody"></tbody>
                        </table>
                    </div>
                    <div class="mt-4 flex items-center justify-center gap-2" id="pagination"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="text-center py-6 text-gray-500 text-sm">
        <p id="footerText">SLA Management System - Nesma Technology & Industry</p>
        <p class="mt-1">Last Update: <span id="lastUpdate">-</span></p>
    </footer>

    <script>
        let allData = null;
        let filteredRecords = [];
        let currentPage = 1;
        const recordsPerPage = 50;
        let charts = {};
        const currentLang = 'en'; // Fixed to English

        const translations = {
            ar: {
                pageTitle: 'Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª',
                pageSubtitle: 'ØªØ­Ù„ÙŠÙ„ Ø´Ø§Ù…Ù„ Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„Ù…Ø¹Ø¯Ø§Øª',
                langText: 'English',
                exportText: 'ØªØµØ¯ÙŠØ±',
                filtersTitle: 'Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©',
                resetBtn: 'Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†',
                projectLabel: 'Ø§Ù„Ù…Ø´Ø±ÙˆØ¹',
                supplierLabel: 'Ø§Ù„Ù…ÙˆØ±Ø¯',
                equipmentLabel: 'Ø§Ù„Ù…Ø¹Ø¯Ø§Øª',
                statusLabel: 'Ø§Ù„Ø­Ø§Ù„Ø©',
                rentTypeLabel: 'Ù†ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±',
                dateFromLabel: 'Ù…Ù† ØªØ§Ø±ÙŠØ®',
                kpiTotalOrdersLabel: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª',
                kpiTotalAmountLabel: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº (Ø±ÙŠØ§Ù„)',
                kpiDoneLabel: 'Ù…ÙƒØªÙ…Ù„Ø©',
                kpiInProgressLabel: 'Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°',
                kpiAvgDurationLabel: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¯Ø© (ÙŠÙˆÙ…)',
                kpiOnTimeRateLabel: 'Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²',
                tabOverview: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©',
                tabSuppliers: 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',
                tabProjects: 'Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹',
                tabEquipment: 'Ø§Ù„Ù…Ø¹Ø¯Ø§Øª',
                tabDetails: 'Ø§Ù„ØªÙØ§ØµÙŠÙ„',
                recordsOfLabel: 'Ù…Ù†',
                footerText: 'Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§ØªÙØ§Ù‚ÙŠØ§Øª Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø¯Ù…Ø© - Ù†Ø³Ù…Ø§ Ù„Ù„ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ ÙˆØ§Ù„ØµÙ†Ø§Ø¹Ø©',
                all: 'Ø§Ù„ÙƒÙ„',
                chartStatusDistribution: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª',
                chartMonthlyTrend: 'Ø§Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
                chartSupplierDistribution: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',
                chartProjectDistribution: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹'
            },
            en: {
                pageTitle: 'Transportation & Equipment Dashboard',
                pageSubtitle: 'Comprehensive Analysis of Transportation Orders',
                langText: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                exportText: 'Export',
                filtersTitle: 'Interactive Filters',
                resetBtn: 'Reset',
                projectLabel: 'Project',
                supplierLabel: 'Supplier',
                equipmentLabel: 'Equipment',
                statusLabel: 'Status',
                rentTypeLabel: 'Rent Type',
                dateFromLabel: 'From Date',
                kpiTotalOrdersLabel: 'Total Orders',
                kpiTotalAmountLabel: 'Total Amount (SAR)',
                kpiDoneLabel: 'Completed',
                kpiInProgressLabel: 'In Progress',
                kpiAvgDurationLabel: 'Avg. Duration (Days)',
                kpiOnTimeRateLabel: 'Completion Rate',
                tabOverview: 'Overview',
                tabSuppliers: 'Suppliers',
                tabProjects: 'Projects',
                tabEquipment: 'Equipment',
                tabDetails: 'Details',
                recordsOfLabel: 'of',
                footerText: 'SLA Management System - Nesma Technology & Industry',
                all: 'All',
                chartStatusDistribution: 'Status Distribution',
                chartMonthlyTrend: 'Monthly Trend',
                chartSupplierDistribution: 'Supplier Distribution',
                chartProjectDistribution: 'Project Distribution'
            }
        };

        // Format number - ALWAYS use English numerals
        function formatNumber(num, decimals = 0) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(num);
        }

        function formatCurrency(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }


        async function loadData() {
            try {
                const response = await fetch('transportation_full_data.json');
                if (!response.ok) throw new Error('Failed to load data');
                allData = await response.json();

                populateFilters();
                filteredRecords = [...allData.records];
                updateDashboard();

                document.getElementById('lastUpdate').textContent = allData.metadata.last_update;
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingText').textContent = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            }
        }

        function populateFilters() {
            const filters = allData.filters;
            const all = translations[currentLang].all;

            const projectSelect = document.getElementById('filterProject');
            projectSelect.innerHTML = `<option value="">${all}</option>`;
            filters.projects.forEach(p => projectSelect.innerHTML += `<option value="${p}">${p}</option>`);

            const supplierSelect = document.getElementById('filterSupplier');
            supplierSelect.innerHTML = `<option value="">${all}</option>`;
            filters.suppliers.forEach(s => supplierSelect.innerHTML += `<option value="${s}">${s}</option>`);

            const equipmentSelect = document.getElementById('filterEquipment');
            equipmentSelect.innerHTML = `<option value="">${all}</option>`;
            filters.equipment.forEach(e => equipmentSelect.innerHTML += `<option value="${e}">${e}</option>`);

            const statusSelect = document.getElementById('filterStatus');
            statusSelect.innerHTML = `<option value="">${all}</option>`;
            filters.status.forEach(s => statusSelect.innerHTML += `<option value="${s}">${s}</option>`);

            const rentTypeSelect = document.getElementById('filterRentType');
            rentTypeSelect.innerHTML = `<option value="">${all}</option>`;
            filters.rent_types.forEach(r => rentTypeSelect.innerHTML += `<option value="${r}">${r}</option>`);
        }

        function updateFilterOptions() {
            const all = translations[currentLang].all;
            ['filterProject', 'filterSupplier', 'filterEquipment', 'filterStatus', 'filterRentType'].forEach(id => {
                const select = document.getElementById(id);
                if (select && select.options[0]) select.options[0].text = all;
            });
        }

        function applyFilters() {
            const project = document.getElementById('filterProject').value;
            const supplier = document.getElementById('filterSupplier').value;
            const equipment = document.getElementById('filterEquipment').value;
            const status = document.getElementById('filterStatus').value;
            const rentType = document.getElementById('filterRentType').value;
            const dateFrom = document.getElementById('filterDateFrom').value;

            filteredRecords = allData.records.filter(r => {
                if (project && r.project !== project) return false;
                if (supplier && r.supplier !== supplier) return false;
                if (equipment && r.equipment_1 !== equipment) return false;
                if (status && r.status !== status) return false;
                if (rentType && r.rent_type !== rentType) return false;
                if (dateFrom && r.request_date < dateFrom) return false;
                return true;
            });

            currentPage = 1;
            updateDashboard();
            updateActiveFilters();
        }

        function resetFilters() {
            document.getElementById('filterProject').value = '';
            document.getElementById('filterSupplier').value = '';
            document.getElementById('filterEquipment').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterRentType').value = '';
            document.getElementById('filterDateFrom').value = '';

            filteredRecords = [...allData.records];
            currentPage = 1;
            updateDashboard();
            updateActiveFilters();
        }

        function updateActiveFilters() {
            const container = document.getElementById('activeFilters');
            const filters = [];
            const t = translations[currentLang];

            if (document.getElementById('filterProject').value)
                filters.push({ label: t.projectLabel, value: document.getElementById('filterProject').value });
            if (document.getElementById('filterSupplier').value)
                filters.push({ label: t.supplierLabel, value: document.getElementById('filterSupplier').value });
            if (document.getElementById('filterEquipment').value)
                filters.push({ label: t.equipmentLabel, value: document.getElementById('filterEquipment').value });
            if (document.getElementById('filterStatus').value)
                filters.push({ label: t.statusLabel, value: document.getElementById('filterStatus').value });

            if (filters.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            container.innerHTML = filters.map(f => `<span class="badge badge-info">${f.label}: ${f.value}</span>`).join('');
        }

        function updateDashboard() {
            updateKPIs();
            updateCharts();
            updateTables();
        }

        function updateKPIs() {
            const records = filteredRecords;
            const totalOrders = records.length;
            const totalAmount = records.reduce((sum, r) => sum + (r.total_amount || 0), 0);
            const doneCount = records.filter(r => r.status === 'Done').length;
            const inProgressCount = records.filter(r => r.status === 'In Progress').length;
            const avgDuration = records.reduce((sum, r) => sum + (r.duration || 0), 0) / records.length || 0;
            const onTimeRate = totalOrders > 0 ? (doneCount / totalOrders * 100) : 0;

            document.getElementById('kpiTotalOrders').textContent = formatNumber(totalOrders);
            document.getElementById('kpiTotalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('kpiDoneCount').textContent = formatNumber(doneCount);
            document.getElementById('kpiInProgressCount').textContent = formatNumber(inProgressCount);
            document.getElementById('kpiAvgDuration').textContent = formatNumber(avgDuration, 1);
            document.getElementById('kpiOnTimeRate').textContent = formatNumber(onTimeRate, 1) + '%';
        }

        function updateCharts() {
            updateStatusChart();
            updateMonthlyTrendChart();
            updateSupplierBarChart();
            updateSupplierPieChart();
            updateProjectBarChart();
            updateEquipmentChart();
        }

        function updateStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            const statusCounts = {};
            filteredRecords.forEach(r => {
                const status = r.status || 'Unknown';
                statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            const labels = Object.keys(statusCounts);
            const data = Object.values(statusCounts);
            const colors = ['#10b981', '#f59e0b', '#ef4444', '#3b82f6'];

            if (charts.statusChart) charts.statusChart.destroy();
            charts.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: colors.slice(0, labels.length), borderWidth: 0 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: currentLang === 'ar' ? 'right' : 'left' },
                        title: { display: true, text: translations[currentLang].chartStatusDistribution, font: { size: 16, weight: 'bold' } }
                    }
                }
            });
        }

        function updateMonthlyTrendChart() {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');
            const monthlyData = {};
            filteredRecords.forEach(r => {
                if (r.request_date) {
                    const month = r.request_date.substring(0, 7);
                    if (!monthlyData[month]) monthlyData[month] = { count: 0, amount: 0 };
                    monthlyData[month].count++;
                    monthlyData[month].amount += r.total_amount || 0;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const counts = sortedMonths.map(m => monthlyData[m].count);

            if (charts.monthlyTrendChart) charts.monthlyTrendChart.destroy();
            charts.monthlyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{ label: currentLang === 'ar' ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª' : 'Order Count', data: counts, borderColor: '#2e3192', backgroundColor: 'rgba(46, 49, 146, 0.1)', fill: true, tension: 0.4 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { title: { display: true, text: translations[currentLang].chartMonthlyTrend, font: { size: 16, weight: 'bold' } } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function updateSupplierBarChart() {
            const ctx = document.getElementById('supplierBarChart').getContext('2d');
            const supplierData = {};
            filteredRecords.forEach(r => {
                const supplier = r.supplier || 'Unknown';
                if (!supplierData[supplier]) supplierData[supplier] = { count: 0, amount: 0 };
                supplierData[supplier].count++;
                supplierData[supplier].amount += r.total_amount || 0;
            });

            const sorted = Object.entries(supplierData).sort((a, b) => b[1].amount - a[1].amount).slice(0, 10);
            const labels = sorted.map(s => s[0]);
            const amounts = sorted.map(s => s[1].amount);

            if (charts.supplierBarChart) charts.supplierBarChart.destroy();
            charts.supplierBarChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ label: currentLang === 'ar' ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº' : 'Total Amount', data: amounts, backgroundColor: '#2e3192', borderRadius: 8 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { title: { display: true, text: translations[currentLang].chartSupplierDistribution, font: { size: 16, weight: 'bold' } } }
                }
            });
        }

        function updateSupplierPieChart() {
            const ctx = document.getElementById('supplierPieChart').getContext('2d');
            const supplierData = {};
            filteredRecords.forEach(r => {
                const supplier = r.supplier || 'Unknown';
                supplierData[supplier] = (supplierData[supplier] || 0) + (r.total_amount || 0);
            });

            const sorted = Object.entries(supplierData).sort((a, b) => b[1] - a[1]).slice(0, 8);
            const colors = ['#2e3192', '#80d1e9', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6'];

            if (charts.supplierPieChart) charts.supplierPieChart.destroy();
            charts.supplierPieChart = new Chart(ctx, {
                type: 'pie',
                data: { labels: sorted.map(s => s[0]), datasets: [{ data: sorted.map(s => s[1]), backgroundColor: colors }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        function updateProjectBarChart() {
            const ctx = document.getElementById('projectBarChart').getContext('2d');
            const projectData = {};
            filteredRecords.forEach(r => {
                const project = r.project || 'Unknown';
                if (!projectData[project]) projectData[project] = { count: 0, amount: 0 };
                projectData[project].count++;
                projectData[project].amount += r.total_amount || 0;
            });

            const sorted = Object.entries(projectData).sort((a, b) => b[1].amount - a[1].amount).slice(0, 15);

            if (charts.projectBarChart) charts.projectBarChart.destroy();
            charts.projectBarChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: sorted.map(s => s[0]), datasets: [{ label: currentLang === 'ar' ? 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº' : 'Total Amount', data: sorted.map(s => s[1].amount), backgroundColor: '#80d1e9', borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { title: { display: true, text: translations[currentLang].chartProjectDistribution, font: { size: 16, weight: 'bold' } } } }
            });
        }

        function updateEquipmentChart() {
            const ctx = document.getElementById('equipmentChart').getContext('2d');
            const eqData = {};
            filteredRecords.forEach(r => {
                const eq = r.equipment_1 || 'Unknown';
                if (!eqData[eq]) eqData[eq] = { count: 0, amount: 0 };
                eqData[eq].count++;
                eqData[eq].amount += r.total_amount || 0;
            });

            const sorted = Object.entries(eqData).sort((a, b) => b[1].count - a[1].count).slice(0, 15);

            if (charts.equipmentChart) charts.equipmentChart.destroy();
            charts.equipmentChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: sorted.map(s => s[0]), datasets: [{ label: currentLang === 'ar' ? 'Ø§Ù„Ø¹Ø¯Ø¯' : 'Count', data: sorted.map(s => s[1].count), backgroundColor: '#10b981', borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y' }
            });
        }

        function updateTables() {
            updateSuppliersTable();
            updateProjectsTable();
            updateEquipmentTable();
            updateDetailsTable();
        }

        function updateSuppliersTable() {
            const tbody = document.getElementById('suppliersTableBody');
            const supplierData = {};
            const totalAmount = filteredRecords.reduce((sum, r) => sum + (r.total_amount || 0), 0);

            filteredRecords.forEach(r => {
                const supplier = r.supplier || 'Unknown';
                if (!supplierData[supplier]) supplierData[supplier] = { count: 0, amount: 0 };
                supplierData[supplier].count++;
                supplierData[supplier].amount += r.total_amount || 0;
            });

            const sorted = Object.entries(supplierData).sort((a, b) => b[1].amount - a[1].amount);
            tbody.innerHTML = sorted.map(([supplier, data]) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium">${supplier}</td>
                    <td class="px-4 py-3">${formatNumber(data.count)}</td>
                    <td class="px-4 py-3">${formatCurrency(data.amount)}</td>
                    <td class="px-4 py-3">${formatCurrency(data.amount / data.count)}</td>
                    <td class="px-4 py-3">${formatNumber((data.amount / totalAmount * 100), 1)}%</td>
                </tr>
            `).join('');
        }

        function updateProjectsTable() {
            const tbody = document.getElementById('projectsTableBody');
            const projectData = {};

            filteredRecords.forEach(r => {
                const project = r.project || 'Unknown';
                if (!projectData[project]) projectData[project] = { count: 0, amount: 0, durations: [] };
                projectData[project].count++;
                projectData[project].amount += r.total_amount || 0;
                if (r.duration) projectData[project].durations.push(r.duration);
            });

            const sorted = Object.entries(projectData).sort((a, b) => b[1].amount - a[1].amount);
            tbody.innerHTML = sorted.map(([project, data]) => {
                const avgDuration = data.durations.length > 0 ? data.durations.reduce((a, b) => a + b, 0) / data.durations.length : 0;
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium">${project}</td>
                        <td class="px-4 py-3">${formatNumber(data.count)}</td>
                        <td class="px-4 py-3">${formatCurrency(data.amount)}</td>
                        <td class="px-4 py-3">${formatNumber(avgDuration, 1)}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateEquipmentTable() {
            const tbody = document.getElementById('equipmentTableBody');
            const eqData = {};

            filteredRecords.forEach(r => {
                const eq = r.equipment_1 || 'Unknown';
                if (!eqData[eq]) eqData[eq] = { count: 0, amount: 0 };
                eqData[eq].count++;
                eqData[eq].amount += r.total_amount || 0;
            });

            const sorted = Object.entries(eqData).sort((a, b) => b[1].count - a[1].count);
            tbody.innerHTML = sorted.map(([eq, data]) => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-3 font-medium">${eq}</td>
                    <td class="px-4 py-3">${formatNumber(data.count)}</td>
                    <td class="px-4 py-3">${formatCurrency(data.amount)}</td>
                    <td class="px-4 py-3">${formatCurrency(data.amount / data.count)}</td>
                </tr>
            `).join('');
        }

        function updateDetailsTable() {
            const tbody = document.getElementById('detailsTableBody');
            const start = (currentPage - 1) * recordsPerPage;
            const end = start + recordsPerPage;
            const pageRecords = filteredRecords.slice(start, end);

            document.getElementById('recordsShowing').textContent = formatNumber(Math.min(end, filteredRecords.length));
            document.getElementById('recordsTotal').textContent = formatNumber(filteredRecords.length);

            tbody.innerHTML = pageRecords.map((r, i) => {
                const statusClass = r.status === 'Done' ? 'badge-success' : r.status === 'In Progress' ? 'badge-warning' : 'badge-danger';
                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-3 py-2">${formatNumber(start + i + 1)}</td>
                        <td class="px-3 py-2 font-mono">${r.job_order_no || '-'}</td>
                        <td class="px-3 py-2">${r.request_date || '-'}</td>
                        <td class="px-3 py-2">${r.project || '-'}</td>
                        <td class="px-3 py-2">${r.supplier || '-'}</td>
                        <td class="px-3 py-2">${r.equipment_1 || '-'}</td>
                        <td class="px-3 py-2 font-medium">${formatCurrency(r.total_amount || 0)}</td>
                        <td class="px-3 py-2"><span class="badge ${statusClass}">${r.status || '-'}</span></td>
                    </tr>
                `;
            }).join('');

            updatePagination();
        }

        function updatePagination() {
            const container = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);

            if (totalPages <= 1) { container.innerHTML = ''; return; }

            let html = `<button onclick="goToPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="px-3 py-1 rounded border ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'}">${currentLang === 'ar' ? 'Ø§Ù„Ø³Ø§Ø¨Ù‚' : 'Prev'}</button>`;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button onclick="goToPage(${i})" class="px-3 py-1 rounded ${i === currentPage ? 'bg-[#2e3192] text-white' : 'hover:bg-gray-100'}">${formatNumber(i)}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += '<span class="px-2">...</span>';
                }
            }

            html += `<button onclick="goToPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''} class="px-3 py-1 rounded border ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100'}">${currentLang === 'ar' ? 'Ø§Ù„ØªØ§Ù„ÙŠ' : 'Next'}</button>`;

            container.innerHTML = html;
        }

        function goToPage(page) {
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            updateDetailsTable();
        }

        function searchRecords() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (!query) { applyFilters(); return; }

            filteredRecords = allData.records.filter(r => {
                const searchFields = [r.job_order_no, r.project, r.supplier, r.equipment_1, r.requester, r.status].filter(Boolean).join(' ').toLowerCase();
                return searchFields.includes(query);
            });

            currentPage = 1;
            updateDashboard();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName + 'Content').classList.remove('hidden');
            event.target.classList.add('active');
        }

        function exportData() {
            const data = filteredRecords.map(r => ({
                'Job Order': r.job_order_no,
                'Date': r.request_date,
                'Project': r.project,
                'Supplier': r.supplier,
                'Equipment': r.equipment_1,
                'Amount': r.total_amount,
                'Status': r.status
            }));

            const csv = [Object.keys(data[0]).join(','), ...data.map(row => Object.values(row).map(v => `"${v || ''}"`).join(','))].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'transportation_data_export.csv';
            link.click();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('nesma_lang');
            if (savedLang) {
                currentLang = savedLang;
                applyLanguage();
            }
            loadData();
        });
    </script>
</body>
</html>