<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NESMA | SLA Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="data.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Cairo', sans-serif; }
        :root {
            --nesma-primary: #2e3192;
            --nesma-secondary: #80d1e9;
        }
        .tab-btn.active { background: var(--nesma-primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .kpi-card { transition: transform 0.2s; }
        .kpi-card:hover { transform: translateY(-4px); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-[#2e3192] to-[#1a1a5e] text-white py-4 px-6 shadow-lg">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">NESMA SLA Dashboard</h1>
                <p class="text-sm opacity-80">Job Orders Tracking - <span id="lastUpdate"></span></p>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleLang()" class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30">
                    <span id="langBtn">EN</span>
                </button>
                <button onclick="exportToExcel()" class="px-4 py-2 bg-green-500 rounded-lg hover:bg-green-600">Excel</button>
            </div>
        </div>
    </header>

    <!-- Tabs -->
    <div class="max-w-7xl mx-auto px-4 mt-4">
        <div class="flex gap-2 bg-white rounded-lg p-2 shadow">
            <button onclick="showTab('overview')" class="tab-btn active px-6 py-2 rounded-lg font-medium" data-tab="overview">Overview</button>
            <button onclick="showTab('suppliers')" class="tab-btn px-6 py-2 rounded-lg font-medium hover:bg-gray-100" data-tab="suppliers">Suppliers</button>
            <button onclick="showTab('projects')" class="tab-btn px-6 py-2 rounded-lg font-medium hover:bg-gray-100" data-tab="projects">Projects</button>
            <button onclick="showTab('equipment')" class="tab-btn px-6 py-2 rounded-lg font-medium hover:bg-gray-100" data-tab="equipment">Equipment</button>
            <button onclick="showTab('orders')" class="tab-btn px-6 py-2 rounded-lg font-medium hover:bg-gray-100" data-tab="orders">Orders</button>
        </div>
    </div>

    <!-- Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content active">
            <!-- KPI Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="kpi-card bg-white rounded-xl p-6 shadow border-r-4 border-blue-500">
                    <p class="text-gray-500 text-sm">Total Orders</p>
                    <p class="text-3xl font-bold text-gray-800" id="kpi-total"></p>
                </div>
                <div class="kpi-card bg-white rounded-xl p-6 shadow border-r-4 border-green-500">
                    <p class="text-gray-500 text-sm">Completed</p>
                    <p class="text-3xl font-bold text-green-600" id="kpi-done"></p>
                </div>
                <div class="kpi-card bg-white rounded-xl p-6 shadow border-r-4 border-yellow-500">
                    <p class="text-gray-500 text-sm">Open Orders</p>
                    <p class="text-3xl font-bold text-yellow-600" id="kpi-open"></p>
                </div>
                <div class="kpi-card bg-white rounded-xl p-6 shadow border-r-4 border-purple-500">
                    <p class="text-gray-500 text-sm">On-Time Rate</p>
                    <p class="text-3xl font-bold text-purple-600" id="kpi-ontime"></p>
                </div>
            </div>

            <!-- Second Row KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="kpi-card bg-white rounded-xl p-6 shadow">
                    <p class="text-gray-500 text-sm">Total Amount</p>
                    <p class="text-2xl font-bold text-gray-800" id="kpi-amount"></p>
                </div>
                <div class="kpi-card bg-white rounded-xl p-6 shadow">
                    <p class="text-gray-500 text-sm">Avg Duration</p>
                    <p class="text-2xl font-bold text-gray-800" id="kpi-avg"></p>
                </div>
                <div class="kpi-card bg-white rounded-xl p-6 shadow">
                    <p class="text-gray-500 text-sm">Median (P50)</p>
                    <p class="text-2xl font-bold text-gray-800" id="kpi-median"></p>
                </div>
                <div class="kpi-card bg-white rounded-xl p-6 shadow">
                    <p class="text-gray-500 text-sm">P90 Duration</p>
                    <p class="text-2xl font-bold text-gray-800" id="kpi-p90"></p>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl p-6 shadow">
                    <h3 class="text-lg font-bold mb-4">Order Status</h3>
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="bg-white rounded-xl p-6 shadow">
                    <h3 class="text-lg font-bold mb-4">Monthly Trend</h3>
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Suppliers Tab -->
        <div id="tab-suppliers" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl p-6 shadow">
                    <h3 class="text-lg font-bold mb-4">Top Suppliers by Orders</h3>
                    <canvas id="suppliersChart"></canvas>
                </div>
                <div class="bg-white rounded-xl p-6 shadow">
                    <h3 class="text-lg font-bold mb-4">Suppliers Table</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-right">#</th>
                                    <th class="px-4 py-3 text-right">Supplier</th>
                                    <th class="px-4 py-3 text-right">Orders</th>
                                    <th class="px-4 py-3 text-right">%</th>
                                </tr>
                            </thead>
                            <tbody id="suppliersTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Tab -->
        <div id="tab-projects" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl p-6 shadow">
                    <h3 class="text-lg font-bold mb-4">Top Projects by Cost</h3>
                    <canvas id="projectsChart"></canvas>
                </div>
                <div class="bg-white rounded-xl p-6 shadow">
                    <h3 class="text-lg font-bold mb-4">Projects Table</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-right">#</th>
                                    <th class="px-4 py-3 text-right">Project</th>
                                    <th class="px-4 py-3 text-right">Amount (SAR)</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Tab -->
        <div id="tab-equipment" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl p-6 shadow">
                    <h3 class="text-lg font-bold mb-4">Equipment Distribution</h3>
                    <canvas id="equipmentChart"></canvas>
                </div>
                <div class="bg-white rounded-xl p-6 shadow">
                    <h3 class="text-lg font-bold mb-4">Equipment Table</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-right">#</th>
                                    <th class="px-4 py-3 text-right">Equipment Type</th>
                                    <th class="px-4 py-3 text-right">Count</th>
                                </tr>
                            </thead>
                            <tbody id="equipmentTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Orders Tab -->
        <div id="tab-orders" class="tab-content">
            <div class="bg-white rounded-xl p-6 shadow">
                <h3 class="text-lg font-bold mb-4">Recent Orders (Latest 100)</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-right">Job Order</th>
                                <th class="px-3 py-2 text-right">Date</th>
                                <th class="px-3 py-2 text-right">Project</th>
                                <th class="px-3 py-2 text-right">Equipment</th>
                                <th class="px-3 py-2 text-right">Supplier</th>
                                <th class="px-3 py-2 text-right">Cost</th>
                                <th class="px-3 py-2 text-right">Days</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-4 mt-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm">
            NESMA Infrastructure & Technology | Auto-synced from Smartsheet every hour
        </div>
    </footer>

    <script>
        let currentLang = 'en';
        let charts = {};

        // Format numbers
        function formatNumber(num) {
            if (num >= 1000000) return (num/1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num/1000).toFixed(1) + 'K';
            return num.toLocaleString();
        }

        // Initialize Dashboard
        function initDashboard() {
            const data = SLA_DATA;

            // Update last update date
            document.getElementById('lastUpdate').textContent = data.summary.last_update;

            // KPIs
            document.getElementById('kpi-total').textContent = formatNumber(data.summary.total_orders);
            document.getElementById('kpi-done').textContent = formatNumber(data.summary.done_orders);
            document.getElementById('kpi-open').textContent = formatNumber(data.summary.open_orders);
            document.getElementById('kpi-ontime').textContent = data.summary.on_time_rate + '%';
            document.getElementById('kpi-amount').textContent = formatNumber(data.summary.total_amount) + ' SAR';
            document.getElementById('kpi-avg').textContent = data.summary.avg_duration + ' days';
            document.getElementById('kpi-median').textContent = data.summary.median_duration + ' days';
            document.getElementById('kpi-p90').textContent = data.summary.p90_duration + ' days';

            // Status Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            charts.status = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data.status),
                    datasets: [{
                        data: Object.values(data.status),
                        backgroundColor: ['#22c55e', '#eab308', '#ef4444']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            // Trend Chart
            if (data.monthly_trend && data.monthly_trend.length > 0) {
                const trendCtx = document.getElementById('trendChart').getContext('2d');
                charts.trend = new Chart(trendCtx, {
                    type: 'bar',
                    data: {
                        labels: data.monthly_trend.map(m => m.month),
                        datasets: [{
                            label: 'Orders',
                            data: data.monthly_trend.map(m => m.orders),
                            backgroundColor: '#2e3192'
                        }]
                    },
                    options: { responsive: true, scales: { y: { beginAtZero: true } } }
                });
            }

            // Suppliers Chart & Table
            const suppliers = Object.entries(data.top_suppliers);
            const totalSupplierOrders = suppliers.reduce((sum, [,v]) => sum + v, 0);

            const suppliersCtx = document.getElementById('suppliersChart').getContext('2d');
            charts.suppliers = new Chart(suppliersCtx, {
                type: 'bar',
                data: {
                    labels: suppliers.map(([k]) => k),
                    datasets: [{
                        label: 'Orders',
                        data: suppliers.map(([,v]) => v),
                        backgroundColor: '#80d1e9'
                    }]
                },
                options: { indexAxis: 'y', responsive: true }
            });

            let suppliersHTML = '';
            suppliers.forEach(([name, count], i) => {
                const pct = ((count/totalSupplierOrders)*100).toFixed(1);
                suppliersHTML += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-2">${i+1}</td>
                    <td class="px-4 py-2">${name}</td>
                    <td class="px-4 py-2">${count}</td>
                    <td class="px-4 py-2">${pct}%</td>
                </tr>`;
            });
            document.getElementById('suppliersTable').innerHTML = suppliersHTML;

            // Projects Chart & Table
            const projects = Object.entries(data.top_projects);

            const projectsCtx = document.getElementById('projectsChart').getContext('2d');
            charts.projects = new Chart(projectsCtx, {
                type: 'bar',
                data: {
                    labels: projects.map(([k]) => k),
                    datasets: [{
                        label: 'Amount (SAR)',
                        data: projects.map(([,v]) => v),
                        backgroundColor: '#2e3192'
                    }]
                },
                options: { indexAxis: 'y', responsive: true }
            });

            let projectsHTML = '';
            projects.forEach(([name, amount], i) => {
                projectsHTML += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-2">${i+1}</td>
                    <td class="px-4 py-2">${name}</td>
                    <td class="px-4 py-2">${formatNumber(amount)}</td>
                </tr>`;
            });
            document.getElementById('projectsTable').innerHTML = projectsHTML;

            // Equipment Chart & Table
            const equipment = Object.entries(data.equipment_distribution);

            const equipmentCtx = document.getElementById('equipmentChart').getContext('2d');
            charts.equipment = new Chart(equipmentCtx, {
                type: 'pie',
                data: {
                    labels: equipment.map(([k]) => k),
                    datasets: [{
                        data: equipment.map(([,v]) => v),
                        backgroundColor: ['#2e3192','#80d1e9','#22c55e','#eab308','#ef4444','#8b5cf6','#f97316','#06b6d4','#ec4899','#6366f1']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'right' } } }
            });

            let equipmentHTML = '';
            equipment.forEach(([name, count], i) => {
                equipmentHTML += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-4 py-2">${i+1}</td>
                    <td class="px-4 py-2">${name}</td>
                    <td class="px-4 py-2">${count}</td>
                </tr>`;
            });
            document.getElementById('equipmentTable').innerHTML = equipmentHTML;

            // Orders Table
            let ordersHTML = '';
            ORDERS_DATA.forEach(order => {
                ordersHTML += `<tr class="border-b hover:bg-gray-50">
                    <td class="px-3 py-2">${order.job_order_no || '-'}</td>
                    <td class="px-3 py-2">${order.job_order_date || '-'}</td>
                    <td class="px-3 py-2">${order.project || '-'}</td>
                    <td class="px-3 py-2">${order.equipment_type || '-'}</td>
                    <td class="px-3 py-2">${order.supplier || '-'}</td>
                    <td class="px-3 py-2">${order.cost || '-'}</td>
                    <td class="px-3 py-2">${order.completion_days || '-'}</td>
                </tr>`;
            });
            document.getElementById('ordersTable').innerHTML = ordersHTML;
        }

        // Tab switching
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        }

        // Language toggle
        function toggleLang() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            localStorage.setItem('nesma_lang', currentLang);
            applyLanguage();
        }

        function applyLanguage() {
            document.getElementById('langBtn').textContent = currentLang === 'en' ? 'AR' : 'EN';
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = currentLang;
        }

        // Export to Excel
        function exportToExcel() {
            const wb = XLSX.utils.book_new();

            // Summary
            const summaryData = [
                ['KPI', 'Value'],
                ['Total Orders', SLA_DATA.summary.total_orders],
                ['Completed', SLA_DATA.summary.done_orders],
                ['Open', SLA_DATA.summary.open_orders],
                ['On-Time Rate', SLA_DATA.summary.on_time_rate + '%'],
                ['Total Amount', SLA_DATA.summary.total_amount],
                ['Avg Duration', SLA_DATA.summary.avg_duration],
            ];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), 'Summary');

            // Suppliers
            const suppliersData = [['Supplier', 'Orders'], ...Object.entries(SLA_DATA.top_suppliers)];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(suppliersData), 'Suppliers');

            // Projects
            const projectsData = [['Project', 'Amount'], ...Object.entries(SLA_DATA.top_projects)];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(projectsData), 'Projects');

            // Orders
            const ordersHeaders = ['Job Order', 'Date', 'Project', 'Equipment', 'Supplier', 'Cost', 'Days'];
            const ordersData = [ordersHeaders, ...ORDERS_DATA.map(o => [
                o.job_order_no, o.job_order_date, o.project, o.equipment_type, o.supplier, o.cost, o.completion_days
            ])];
            XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ordersData), 'Orders');

            XLSX.writeFile(wb, 'NESMA_SLA_' + new Date().toISOString().split('T')[0] + '.xlsx');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('nesma_lang');
            if (savedLang) {
                currentLang = savedLang;
                applyLanguage();
            }
            initDashboard();
        });
    </script>
</body>
</html>
